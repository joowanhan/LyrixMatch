steps:
# --- 1. LFS ì„¤ì¹˜ ë° íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë‹¨ê³„ ---
# 'cloud-sdk' ë¹Œë”ë¥¼ ì‚¬ìš© (Debian ê¸°ë°˜ì´ë©°, ì¸ì¦ ì •ë³´ê°€ ì£¼ì…ë¨)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash' # <-- ê¸°ë³¸ entrypoint(gcloud) ëŒ€ì‹  bash ì‰˜ì„ ì‚¬ìš©
    args:
      - '-c'
      - |
        # 1. íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € ì—…ë°ì´íŠ¸ ë° curl, git ì„¤ì¹˜
        apt-get update
        apt-get install -y curl git

        # 2. git-lfs ì €ì¥ì†Œ ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | bash

        # 3. git-lfs ì„¤ì¹˜
        apt-get install -y git-lfs

        # 4. LFS ëª…ë ¹ ì‹¤í–‰
        git lfs install
        git lfs pull
    timeout: 1200s

# --- 2. Docker Build ë‹¨ê³„ ---
  - name: gcr.io/cloud-builders/docker
    args:
      - build
      - '-t'
      - >-
        us-central1-docker.pkg.dev/$PROJECT_ID/flask-api-repo/lyrics-api:$COMMIT_SHA
      - .
    timeout: 1200s

# --- 3. Docker Push ë‹¨ê³„ ---
  - name: gcr.io/cloud-builders/docker
    args:
      - push
      - >-
        us-central1-docker.pkg.dev/$PROJECT_ID/flask-api-repo/lyrics-api:$COMMIT_SHA

# --- 4. Cloud Run ë°°í¬ ë‹¨ê³„ ---
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    args:
      - run
      - deploy
      - lyrics-api
      - '--image'
      - >-
        us-central1-docker.pkg.dev/$PROJECT_ID/flask-api-repo/lyrics-api:$COMMIT_SHA
      - '--region'
      - us-central1
      - '--platform'
      - managed
      - '--allow-unauthenticated'
      - '--timeout'
      - '1200'
      # --- ğŸ’¡ [ì¶”ê°€] ì‹œì‘ CPU ë¶€ìŠ¤íŠ¸ í™œì„±í™” ---
      # ëª¨ë¸ ë¡œë“œ ì†ë„ë¥¼ ë†’ì´ê¸° ìœ„í•´ ì‹œì‘ ì‹œ CPU í• ë‹¹ëŸ‰ì„ ëŠ˜ë¦°ë‹¤.
      - '--startup-cpu-boost'
      # --- ğŸ’¡ [ì¶”ê°€] ì‹œì‘ í”„ë¡œë¸Œ ì„¤ì • ëª…ì‹œ ---
      - '--startup-probe-http-path=/health'
      - '--startup-probe-period=240'       # every 240s
      - '--startup-probe-timeout=240'      # ì‹œê°„ ì´ˆê³¼ 240s
      - '--startup-probe-failure-threshold=2' # ì‹¤íŒ¨ ê¸°ì¤€ 2
      - '--command'
      - python
      - '--args'
      - api_server.py
      - '--update-secrets'
      - 'SPOTIFY_CLIENT_ID=SPOTIFY_CLIENT_ID:latest'
      - '--update-secrets'
      - 'SPOTIFY_CLIENT_SECRET=SPOTIFY_CLIENT_SECRET:latest'
      - '--update-secrets'
      - 'SPOTIFY_REDIRECT_URI=SPOTIFY_REDIRECT_URI:latest'
      - '--update-secrets'
      - 'GENIUS_TOKEN=GENIUS_TOKEN:latest'
      - '--update-secrets'
      - 'DEEPL_KEY=DEEPL_KEY:latest'
      - '--update-secrets'
      - 'PROXY_URL=PROXY_URL:latest'
      - '--update-secrets'
      - 'GCS_BUCKET_NAME=GCS_BUCKET_NAME:latest'
    entrypoint: gcloud
# --- ì „ì²´ ë¹Œë“œ ì‹œê°„ (1ì‹œê°„) ---
timeout: 3600s
images:
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/flask-api-repo/lyrics-api:$COMMIT_SHA'
options:
  logging: CLOUD_LOGGING_ONLY
