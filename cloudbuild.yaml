steps:
# --- 1. LFS Install 단계 ---
# gcr.io/cloud-builders/git 빌더를 사용 (기본 entrypoint가 'git'임)
# args로 ['lfs', 'install']을 전달하여 'git lfs install' 실행
# 이 빌더는 Cloud Build의 GitHub 인증 정보를 자동으로 사용함
  - name: 'gcr.io/cloud-builders/git'
    args: ['lfs', 'install']
    timeout: 120s

# --- 2. LFS Pull 단계 ---
# 동일한 빌더를 사용하여 'git lfs pull' 실행
  - name: 'gcr.io/cloud-builders/git'
    args: ['lfs', 'pull']
    timeout: 1200s # LFS 파일 다운로드를 위해 넉넉한 타임아웃 설정

# --- 3. Docker Build 단계 ---
  - name: gcr.io/cloud-builders/docker
    args:
      - build
      - '-t'
      - >-
        us-central1-docker.pkg.dev/$PROJECT_ID/flask-api-repo/lyrics-api:$COMMIT_SHA
      - .
    timeout: 1200s

# --- 4. Docker Push 단계 ---
  - name: gcr.io/cloud-builders/docker
    args:
      - push
      - >-
        us-central1-docker.pkg.dev/$PROJECT_ID/flask-api-repo/lyrics-api:$COMMIT_SHA

# --- 5. Cloud Run 배포 단계 ---
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    args:
      - run
      - deploy
      - lyrics-api
      - '--image'
      - >-
        us-central1-docker.pkg.dev/$PROJECT_ID/flask-api-repo/lyrics-api:$COMMIT_SHA
      - '--region'
      - us-central1
      - '--platform'
      - managed
      - '--allow-unauthenticated'
      - '--timeout'
      - '1200'
      - '--command'
      - python
      - '--args'
      - api_server.py
      - '--update-secrets'
      - 'SPOTIFY_CLIENT_ID=SPOTIFY_CLIENT_ID:latest'
      - '--update-secrets'
      - 'SPOTIFY_CLIENT_SECRET=SPOTIFY_CLIENT_SECRET:latest'
      - '--update-secrets'
      - 'SPOTIFY_REDIRECT_URI=SPOTIFY_REDIRECT_URI:latest'
      - '--update-secrets'
      - 'GENIUS_TOKEN=GENIUS_TOKEN:latest'
      - '--update-secrets'
      - 'DEEPL_KEY=DEEPL_KEY:latest'
      - '--update-secrets'
      - 'PROXY_URL=PROXY_URL:latest'
      - '--update-secrets'
      - 'GCS_BUCKET_NAME=GCS_BUCKET_NAME:latest'
    entrypoint: gcloud
# --- 전체 빌드 시간 (1시간) ---
timeout: 3600s
images:
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/flask-api-repo/lyrics-api:$COMMIT_SHA'
options:
  logging: CLOUD_LOGGING_ONLY
